<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFMS - User Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .page { display: none; }
        .page-active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 2rem; border-radius: 0.75rem; max-width: 500px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: scale(0.95); opacity: 0; animation: fadeInScale 0.3s forwards cubic-bezier(0.165, 0.84, 0.44, 1); }
        @keyframes fadeInScale { to { transform: scale(1); opacity: 1; } }
        .step { display: flex; align-items: center; margin-bottom: 1.5rem; opacity: 0.5; transition: opacity 0.5s ease-in-out, transform 0.3s ease; }
        .step.active { opacity: 1; transform: scale(1.02); }
        .step-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; background-color: #e0e7ff; color: #4f46e5; flex-shrink: 0; }
        .step.active .step-icon { background-color: #4f46e5; color: white; }
        .step-line { height: calc(100% - 40px); width: 2px; background-color: #e0e7ff; position: absolute; left: 19px; top: 40px; }
        .step:last-child .step-line { display: none; }
        .tab-active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 600; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <!-- Main Application Container -->
    <div id="app-container">

        <!-- ===== LOGIN PAGE ===== -->
        <div id="page-login" class="page page-active min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-xl shadow-2xl">
                <div class="text-center">
                    <div class="flex justify-center items-center gap-4 mb-4">
                        <i class="fas fa-user-shield text-4xl text-blue-600"></i>
                        <h1 class="text-3xl font-bold text-gray-900">HFMS User Portal</h1>
                    </div>
                    <p class="text-gray-600">Securely sign in to your account.</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Username (Try 'John Doe')</label>
                        <input type="text" id="username" value="Priya Sharma" required class="mt-1 block w-full p-3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" value="password123" required class="mt-1 block w-full p-3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Sign In</button>
                </form>
            </div>
        </div>

        <!-- ===== MAIN APPLICATION PAGE ===== -->
        <div id="page-main" class="page">
            <div class="container mx-auto p-4 md:p-8">
                <header class="flex justify-between items-center mb-10">
                    <div class="flex items-center gap-4">
                        <i class="fas fa-shield-alt text-4xl text-blue-600"></i>
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Holistic Fraud Management System</h1>
                            <p id="welcome-message" class="text-sm text-gray-600">Welcome, Priya Sharma!</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
                </header>

                <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8">
                    <!-- Tabs -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="tab-detection" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm tab-active" onclick="switchTab('detection')"><i class="fas fa-search-dollar mr-2"></i>Real-time Fraud Detection</button>
                            <button id="tab-recovery" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500" onclick="switchTab('recovery')"><i class="fas fa-undo-alt mr-2"></i>Reclaim & Recovery</button>
                        </nav>
                    </div>

                    <!-- Detection Content -->
                    <div id="content-detection" class="py-6">
                        <div id="transaction-start" class="text-center">
                             <div id="kyc-incomplete-banner" class="hidden max-w-md mx-auto bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
                                <p class="font-bold">Account Not Active</p>
                                <p>Please complete your KYC verification to enable transactions.</p>
                             </div>
                            <h2 class="text-2xl font-semibold mb-2">Simulate a Bank Transaction</h2>
                            <p class="mb-6 text-gray-600 max-w-2xl mx-auto">Enter recipient details and amount to see how HFMS analyzes the transaction in real-time.</p>
                            <div class="bg-gray-50 border rounded-lg p-4 max-w-md mx-auto mb-6 text-left">
                                <p><strong>From Account:</strong> <span id="from-account-name">Priya Sharma</span></p>
                                <p><strong>Account Number:</strong> **** **** 1234</p>
                                <p><strong>Balance:</strong> ₹ 2,50,000</p>
                            </div>
                            <form id="transaction-form" class="max-w-md mx-auto space-y-4">
                                <div>
                                    <label for="recipient" class="block text-sm font-medium text-gray-700 text-left">Recipient's UPI ID or Account No.</label>
                                    <input type="text" id="recipient" value="fraud-acct@scamupi" required class="mt-1 block w-full p-3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="amount" class="block text-sm font-medium text-gray-700 text-left">Amount</label>
                                    <div class="relative mt-1 rounded-md shadow-sm">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                            <span class="text-gray-500 sm:text-sm">₹</span>
                                        </div>
                                        <input type="number" id="amount" value="50000" required class="block w-full rounded-md border-gray-300 p-3 pl-7 focus:border-blue-500 focus:ring-blue-500" placeholder="0.00">
                                    </div>
                                </div>
                                <button type="submit" id="proceed-to-pay-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    <i class="fas fa-paper-plane mr-2"></i>Proceed to Pay
                                </button>
                            </form>
                        </div>
                        <div id="transaction-analysis" class="hidden text-center"><div class="flex justify-center items-center mb-4"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-600"></div></div><h2 class="text-2xl font-semibold text-blue-700 mb-2">Analyzing Transaction...</h2><p id="analysis-step" class="text-gray-600"></p></div>
                        <div id="fraud-detected-alert" class="hidden text-center"><div class="flex justify-center items-center mb-4"><i class="fas fa-exclamation-triangle text-6xl text-red-500"></i></div><h2 class="text-3xl font-bold text-red-600 mb-2">High-Risk Transaction Detected!</h2><p class="mb-4 text-gray-700">This transaction has been flagged as suspicious. Notifications sent via SMS, Email, and In-App Alert.</p><div class="bg-red-50 p-4 rounded-lg border border-red-200 mb-6 max-w-2xl mx-auto text-left"><h4 class="font-bold mb-2">Fraud Indicators:</h4><ul class="space-y-2"></ul></div><p class="mb-6 text-gray-600">For your security, please complete biometric verification to proceed.</p><button onclick="showBiometricModal()" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300"><i class="fas fa-user-shield mr-2"></i>Verify with Aadhaar Face Scan</button></div>
                        <div id="transaction-safe" class="hidden text-center"><div class="flex justify-center items-center mb-4"><i class="fas fa-check-circle text-6xl text-green-500"></i></div><h2 class="text-2xl font-bold text-green-600 mb-2">Transaction Successful</h2><p class="mb-6 text-gray-700">The transaction was analyzed and deemed safe. Completed successfully.</p><button onclick="resetSimulation()" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition duration-300">Simulate Another</button></div>
                    </div>

                    <!-- Recovery Content -->
                    <div id="content-recovery" class="hidden py-6">
                        <div id="recovery-start"><h2 class="text-2xl font-semibold mb-2">Fund Recovery Portal</h2><p class="mb-6 text-gray-600">If you've been a victim of fraud, submit your claim here to begin the recovery process.</p><form id="recovery-form" class="space-y-6 bg-gray-50 p-6 rounded-lg border"><div><label for="transactionId" class="block text-sm font-medium text-gray-700">Fraudulent Transaction ID</label><input type="text" name="transactionId" id="transactionId" placeholder="e.g., TXN123456789" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"></div><div><label for="description" class="block text-sm font-medium text-gray-700">Description of Incident</label><textarea name="description" id="description" rows="4" placeholder="Please describe how the fraud occurred..." required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"></textarea></div><div><label for="documents" class="block text-sm font-medium text-gray-700">Upload Proof (Filename must include 'fir' or 'statement')</label><input type="file" name="documents" id="documents" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 cursor-pointer"/></div><div id="recovery-verification-status" class="hidden"></div><div class="text-right"><button type="submit" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300"><i class="fas fa-paper-plane mr-2"></i>Submit Claim</button></div></form></div>
                        <div id="recovery-process" class="hidden mt-8"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-semibold">Case Management for Claim #FRD-98765</h2><button onclick="resetRecovery()" class="text-sm text-blue-600 hover:underline">Submit Another Claim</button></div><div class="grid lg:grid-cols-3 gap-6"><div class="lg:col-span-1 bg-gray-50 p-6 rounded-lg border order-1 lg:order-1"><h3 class="font-semibold text-lg mb-4">Your Recovery Status</h3><div id="step-1" class="step"><div class="relative"><div class="step-icon"><i class="fas fa-file-alt"></i></div><div class="step-line"></div></div><div><p class="font-semibold">Claim Submitted</p><p class="text-sm text-gray-500">Awaiting document verification.</p></div></div><div id="step-2" class="step"><div class="relative"><div class="step-icon"><i class="fas fa-user-secret"></i></div><div class="step-line"></div></div><div><p class="font-semibold">Under Review</p><p class="text-sm text-gray-500">Claim forwarded to Cyber Cell.</p></div></div><div id="step-3" class="step"><div class="relative"><div class="step-icon"><i class="fas fa-check-double"></i></div><div class="step-line"></div></div><div><p class="font-semibold">Documents Verified</p><p class="text-sm text-gray-500">Cyber Cell authenticated all proofs.</p></div></div><div id="step-4" class="step"><div class="relative"><div class="step-icon"><i class="fas fa-university"></i></div><div class="step-line"></div></div><div><p class="font-semibold">Funds Approved</p><p class="text-sm text-gray-500">Bank is processing the fund release.</p></div></div><div id="step-5" class="step"><div class="relative"><div class="step-icon"><i class="fas fa-receipt"></i></div></div><div><p class="font-semibold">Funds Recovered</p><p class="text-sm text-gray-500">Amount credited & Challan sent.</p></div></div></div><div class="lg:col-span-1 bg-white p-6 rounded-lg shadow order-2 lg:order-2"><h3 class="font-semibold text-lg mb-4 text-center"><i class="fas fa-user-secret mr-2"></i>Cyber Cell Portal <span class="text-sm font-normal">(Simulated)</span></h3><div id="cyber-cell-pending"><p class="text-center text-gray-500 p-4">Awaiting claim submission...</p></div><div id="cyber-cell-action" class="hidden text-center"><p class="font-semibold mb-2">New Claim Received:</p><div class="bg-gray-100 p-3 my-2 rounded text-left text-sm"><p><strong>Claim ID:</strong> FRD-98765</p><p><strong>Docs:</strong> fir_copy.pdf, bank_stmt.pdf</p></div><button id="authenticate-btn" onclick="cyberCellAuthenticate()" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 mt-2 transition duration-300">Authenticate Documents</button></div><div id="cyber-cell-done" class="hidden text-center text-green-600 p-4"><i class="fas fa-check-circle text-3xl mb-2"></i><p>Documents Authenticated. Forwarded to Bank.</p></div></div><div class="lg:col-span-1 bg-white p-6 rounded-lg shadow order-3 lg:order-3"><h3 class="font-semibold text-lg mb-4 text-center"><i class="fas fa-university mr-2"></i>Bank Portal <span class="text-sm font-normal">(Simulated)</span></h3><div id="bank-pending"><p class="text-center text-gray-500 p-4">Awaiting Cyber Cell authentication...</p></div><div id="bank-action" class="hidden text-center"><p class="font-semibold mb-2">Authentication Received:</p><div class="bg-green-50 border border-green-200 p-3 my-2 rounded text-left text-sm"><p><strong>Claim ID:</strong> FRD-98765</p><p><strong>Cyber Cell:</strong> Verified</p></div><button id="release-btn" onclick="bankReleaseFunds()" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 mt-2 transition duration-300 disabled:opacity-50" disabled>Approve Fund Release</button></div><div id="bank-done" class="hidden text-center text-green-600 p-4"><i class="fas fa-check-circle text-3xl mb-2"></i><p>Funds Released. Case Closed.</p></div></div></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODALS ===== -->
    <div id="kyc-modal" class="modal-overlay hidden"><div class="modal-content text-center">
        <i class="fas fa-id-card text-5xl text-blue-500 mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">KYC Verification Required</h2>
        <div id="kyc-step-1"><p class="text-gray-600 mb-6">To activate your account, please upload your documents. <br><small>(Use filenames containing 'aadhaar' or 'pan')</small></p><div class="space-y-4 text-left"><div><label for="pan-upload" class="text-sm font-medium">Upload PAN Card:</label><input type="file" id="pan-upload" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-100 file:text-blue-700"><p id="pan-status" class="text-xs mt-1"></p></div><div><label for="aadhaar-upload" class="text-sm font-medium">Upload Aadhaar Card:</label><input type="file" id="aadhaar-upload" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-100 file:text-blue-700"><p id="aadhaar-status" class="text-xs mt-1"></p></div></div></div>
        <div id="kyc-step-2" class="hidden"><p class="text-gray-600 mb-6">Please review the extracted details and confirm.</p><div id="kyc-details-review" class="bg-gray-50 border p-4 rounded-lg text-left my-4 space-y-1"></div><button onclick="confirmKycDetails()" class="mt-4 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Details are Correct</button></div>
        <div id="kyc-step-3" class="hidden"><p class="text-gray-600 mb-4">Proceed to live photo verification to complete your KYC.</p><button onclick="startCameraVerification()" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Proceed to Live Photo</button></div>
    </div></div>
    
    <div id="camera-modal" class="modal-overlay hidden"><div class="modal-content text-center">
        <h2 class="text-2xl font-bold mb-4">Live Photo & Face Match</h2>
        <div id="face-match-step-1"><p class="text-gray-600 mb-4">Please position your face within the frame.</p><video id="camera-feed" autoplay class="w-full rounded-lg bg-gray-200"></video><button onclick="capturePhoto()" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Capture & Verify</button></div>
        <div id="face-match-step-2" class="hidden"><p class="text-gray-600 mb-4">Comparing live photo with document photo...</p><div class="flex justify-center items-center gap-4"><img id="live-photo-preview" class="w-1/2 rounded-lg border-2 border-blue-500" src="https://placehold.co/200x200/e2e8f0/4a5568?text=Live+Photo"><img class="w-1/2 rounded-lg border-2" src="https://placehold.co/200x200/e2e8f0/4a5568?text=Doc+Photo"></div><div id="face-match-spinner" class="flex items-center justify-center mt-4"><div class="spinner"></div><p class="ml-4 text-blue-600">Analyzing...</p></div><div id="face-match-result" class="hidden mt-4"></div></div>
    </div></div>

    <div id="pre-transaction-modal" class="modal-overlay hidden"><div class="modal-content text-center">
        <h2 class="text-2xl font-bold mb-4">Final Security Check</h2>
        <p class="text-gray-600 mb-4">For your security, we need to perform a quick face match before proceeding with the payment.</p>
        <div class="flex justify-center items-center gap-4 my-4">
            <div>
                <p class="font-semibold text-sm">KYC Photo</p>
                <img id="pre-trans-kyc-photo" class="h-32 w-32 rounded-lg border-2" src="https://placehold.co/200x200/e2e8f0/4a5568?text=KYC+Photo">
            </div>
            <div>
                 <p class="font-semibold text-sm">Live Camera</p>
                <video id="pre-trans-live-feed" autoplay class="h-32 w-32 rounded-lg bg-gray-200 border-2"></video>
            </div>
        </div>
        <div id="pre-trans-spinner" class="hidden items-center justify-center mt-4"><div class="spinner"></div><p class="ml-4 text-blue-600">Verifying...</p></div>
        <div id="pre-trans-result" class="hidden mt-4"></div>
        <button id="pre-trans-confirm-btn" onclick="confirmPreTransaction()" class="mt-4 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Confirm & Pay</button>
    </div></div>

    <div id="biometric-modal" class="modal-overlay hidden"><div class="modal-content text-center"><h2 class="text-2xl font-bold mb-4">Aadhaar Face Scan</h2><p class="text-gray-600 mb-4">Verifying your identity for this high-risk transaction...</p><video id="biometric-feed" autoplay class="w-full rounded-lg bg-gray-200 h-48 object-cover"></video><div id="biometric-spinner" class="hidden flex-col items-center justify-center mt-4"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div><p class="mt-2 text-blue-600">Scanning...</p></div><div id="biometric-result" class="hidden"></div></div></div>
    <div id="action-modal" class="modal-overlay hidden"><div class="modal-content text-center"><h2 class="text-2xl font-bold mb-2">Verification Successful!</h2><p class="text-gray-600 mb-6">Your identity has been confirmed. What action would you like to take for the suspicious transaction?</p><div class="flex justify-center space-x-4"><button onclick="performAction('freeze')" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition">Freeze Account</button><button onclick="performAction('block')" class="bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-yellow-600 transition">Block Transaction</button></div></div></div>
    <div id="result-modal" class="modal-overlay hidden"><div class="modal-content text-center"><div id="result-icon"></div><h2 id="result-title" class="text-2xl font-bold mb-2"></h2><p id="result-message" class="text-gray-600 mb-6"></p><button onclick="closeAllModals()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Close</button></div></div>
    <div id="challan-modal" class="modal-overlay hidden"><div class="modal-content text-center"><i class="fas fa-receipt text-5xl text-green-500 mb-4"></i><h2 class="text-2xl font-bold mb-2">Challan Generated</h2><div class="bg-gray-50 border p-4 rounded-lg text-left my-4 space-y-1" id="challan-details"></div><p class="text-gray-600 mb-6">A copy has been sent to your registered email and the Cyber Cell for records.</p><button onclick="document.getElementById('challan-modal').classList.add('hidden'); resetRecovery();" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Close</button></div></div>


    <script>
        // --- App State & Navigation ---
        const TABS = ['detection', 'recovery'];
        let cameraStream;
        let currentRecoveryCase = { id: null, amount: null };
        let currentUsername = 'Priya Sharma';
        let kycStatus = {
            panVerified: false,
            aadhaarVerified: false,
            livePhotoVerified: false,
            livePhotoUrl: '',
            details: {}
        };

        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('page-active'));
            document.getElementById(pageId).classList.add('page-active');
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const usernameInput = document.getElementById('username').value;
            currentUsername = usernameInput.trim() !== "" ? usernameInput.trim() : 'Priya Sharma';
            
            document.getElementById('welcome-message').textContent = `Welcome, ${currentUsername}!`;
            document.getElementById('from-account-name').textContent = currentUsername;

            navigateTo('page-main');
            resetKycProcess();
            document.getElementById('kyc-modal').classList.remove('hidden');
        });

        function logout() {
            navigateTo('page-login');
            localStorage.removeItem('hfms-transactions');
            window.dispatchEvent(new StorageEvent('storage', { key: 'hfms-transactions' }));
        }

        // --- KYC & Document Verification Logic ---
        function resetKycProcess() {
            kycStatus = { panVerified: false, aadhaarVerified: false, livePhotoVerified: false, livePhotoUrl: '', details: {} };
            document.getElementById('kyc-step-1').classList.remove('hidden');
            document.getElementById('kyc-step-2').classList.add('hidden');
            document.getElementById('kyc-step-3').classList.add('hidden');
            document.getElementById('pan-upload').value = '';
            document.getElementById('aadhaar-upload').value = '';
            document.getElementById('pan-status').textContent = '';
            document.getElementById('aadhaar-status').textContent = '';
            document.getElementById('proceed-to-pay-btn').disabled = true;
            document.getElementById('kyc-incomplete-banner').classList.remove('hidden');
        }

        function simulateOCR(file, docType) {
            return new Promise((resolve, reject) => {
                const statusEl = document.getElementById(`${docType}-status`);
                statusEl.className = 'text-xs mt-1 text-blue-600';
                statusEl.textContent = 'Scanning...';
                
                setTimeout(() => {
                    if (file && file.name.toLowerCase().includes(docType)) {
                        statusEl.className = 'text-xs mt-1 text-green-600';
                        statusEl.textContent = 'Scan successful. Details extracted.';
                        let data = {};
                        if(docType === 'pan') {
                             data = { name: currentUsername, pan: 'ABCDE1234F', dob: '01/01/1990' };
                        } else {
                             data = { name: currentUsername, aadhaar: '1234 5678 9012', dob: '01/01/1990', address: 'Mumbai, India' };
                        }
                        resolve(data);
                    } else {
                        statusEl.className = 'text-xs mt-1 text-red-600';
                        statusEl.textContent = `Invalid file. Please use a filename containing '${docType}'.`;
                        reject(`Invalid ${docType} file.`);
                    }
                }, 1500);
            });
        }

        document.getElementById('pan-upload').addEventListener('change', async (e) => {
            try {
                const data = await simulateOCR(e.target.files[0], 'pan');
                kycStatus.details.pan = data;
                kycStatus.panVerified = true;
                checkKycDocuments();
            } catch (error) { kycStatus.panVerified = false; }
        });

        document.getElementById('aadhaar-upload').addEventListener('change', async (e) => {
            try {
                const data = await simulateOCR(e.target.files[0], 'aadhaar');
                kycStatus.details.aadhaar = data;
                kycStatus.aadhaarVerified = true;
                checkKycDocuments();
            } catch (error) { kycStatus.aadhaarVerified = false; }
        });

        function checkKycDocuments() {
            if (kycStatus.panVerified && kycStatus.aadhaarVerified) {
                document.getElementById('kyc-step-1').classList.add('hidden');
                const reviewDiv = document.getElementById('kyc-details-review');
                reviewDiv.innerHTML = `<p><strong>Name:</strong> ${kycStatus.details.pan.name}</p><p><strong>PAN:</strong> ${kycStatus.details.pan.pan}</p><p><strong>Aadhaar:</strong> ${kycStatus.details.aadhaar.aadhaar}</p><p><strong>Date of Birth:</strong> ${kycStatus.details.pan.dob}</p>`;
                document.getElementById('kyc-step-2').classList.remove('hidden');
            }
        }
        
        function confirmKycDetails() {
            document.getElementById('kyc-step-2').classList.add('hidden');
            document.getElementById('kyc-step-3').classList.remove('hidden');
        }

        function startCameraVerification() {
            document.getElementById('kyc-modal').classList.add('hidden');
            document.getElementById('camera-modal').classList.remove('hidden');
            document.getElementById('face-match-step-1').classList.remove('hidden');
            document.getElementById('face-match-step-2').classList.add('hidden');
            navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                cameraStream = stream;
                document.getElementById('camera-feed').srcObject = stream;
            }).catch(err => {
                alert("Camera access is required for KYC.");
                document.getElementById('camera-modal').classList.add('hidden');
            });
        }
        
        function capturePhoto() {
            const video = document.getElementById('camera-feed');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const dataUrl = canvas.toDataURL('image/png');
            kycStatus.livePhotoUrl = dataUrl;
            document.getElementById('live-photo-preview').src = dataUrl;

            if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); }

            document.getElementById('face-match-step-1').classList.add('hidden');
            document.getElementById('face-match-step-2').classList.remove('hidden');
            document.getElementById('face-match-result').classList.add('hidden');
            document.getElementById('face-match-spinner').classList.remove('hidden');
            
            setTimeout(() => {
                kycStatus.livePhotoVerified = true;
                document.getElementById('face-match-spinner').classList.add('hidden');
                const resultEl = document.getElementById('face-match-result');
                resultEl.innerHTML = `<p class="text-green-600 font-semibold"><i class="fas fa-check-circle"></i> Face Match Successful. KYC Verified!</p>`;
                resultEl.classList.remove('hidden');

                setTimeout(() => {
                    document.getElementById('camera-modal').classList.add('hidden');
                    document.getElementById('proceed-to-pay-btn').disabled = false;
                    document.getElementById('kyc-incomplete-banner').classList.add('hidden');
                }, 2000);
            }, 2500);
        }
        
        // --- Tab Switching ---
        function switchTab(tabId) { TABS.forEach(id => { document.getElementById(`tab-${id}`).classList.remove('tab-active'); document.getElementById(`content-${id}`).classList.add('hidden'); }); document.getElementById(`tab-${tabId}`).classList.add('tab-active'); document.getElementById(`content-${tabId}`).classList.remove('hidden'); }

        // --- Transaction Logic ---
        const transactionForm = document.getElementById('transaction-form');
        transactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!kycStatus.livePhotoVerified) {
                alert("Please complete KYC verification before making a transaction.");
                return;
            }
            showPreTransactionVerification();
        });

        function showPreTransactionVerification() {
            const modal = document.getElementById('pre-transaction-modal');
            modal.classList.remove('hidden');
            document.getElementById('pre-trans-spinner').classList.add('hidden');
            document.getElementById('pre-trans-result').classList.add('hidden');
            document.getElementById('pre-trans-confirm-btn').disabled = false;
            document.getElementById('pre-trans-kyc-photo').src = kycStatus.livePhotoUrl;

            navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                cameraStream = stream;
                document.getElementById('pre-trans-live-feed').srcObject = stream;
            }).catch(err => {
                alert("Camera access is required for this security check.");
                modal.classList.add('hidden');
            });
        }
        
        function confirmPreTransaction() {
            document.getElementById('pre-trans-confirm-btn').disabled = true;
            document.getElementById('pre-trans-spinner').classList.remove('hidden');
            if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); }
            
            // Simulate a more realistic face match API call
            setTimeout(() => {
                const resultEl = document.getElementById('pre-trans-result');
                // Simulate a failure if the user's face is obstructed.
                // In a real app, this would be a sophisticated API call.
                const isFaceClear = Math.random() > 0.25; // 75% chance of success

                document.getElementById('pre-trans-spinner').classList.add('hidden');
                resultEl.classList.remove('hidden');

                if (isFaceClear) {
                    resultEl.innerHTML = `<p class="text-green-600 font-semibold"><i class="fas fa-check-circle"></i> Face Verified. Processing payment...</p>`;
                    setTimeout(() => {
                        document.getElementById('pre-transaction-modal').classList.add('hidden');
                        initiateTransaction();
                    }, 1500);
                } else {
                    resultEl.innerHTML = `<p class="text-red-600 font-semibold"><i class="fas fa-times-circle"></i> Verification Failed. Face not clear or obstructed.</p>`;
                    // After showing the error, reset the modal for another attempt.
                    setTimeout(() => {
                        document.getElementById('pre-transaction-modal').classList.add('hidden');
                        // Re-open the modal to allow the user to try again.
                        showPreTransactionVerification();
                    }, 2500);
                }
            }, 2000);
        }

        function initiateTransaction() {
            const recipient = document.getElementById('recipient').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const formattedAmount = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }).format(amount);
            
            document.getElementById('transaction-start').classList.add('hidden');
            document.getElementById('transaction-analysis').classList.remove('hidden');
            
            const isFraudulent = Math.random() > 0.3 || amount > 100000 || recipient.toLowerCase().includes('fraud');
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute:'2-digit', hour12: true });
            const fraudReasons = [];
            if (isFraudulent) { if (Math.random() > 0.5) fraudReasons.push(`<li><i class="fas fa-map-marker-alt text-red-500 mr-2"></i><span class="font-semibold">Unusual Location:</span> Transaction from <span class="font-bold">Delhi, IN</span>.</li>`); if (Math.random() > 0.5) fraudReasons.push(`<li><i class="fas fa-mobile-alt text-red-500 mr-2"></i><span class="font-semibold">New Device:</span> Unrecognized device signature detected.</li>`); if (amount > 75000) fraudReasons.push(`<li><i class="fas fa-history text-red-500 mr-2"></i><span class="font-semibold">High-Value Transfer:</span> Amount of ${formattedAmount} is unusual.</li>`); if (recipient.toLowerCase().includes('fraud')) fraudReasons.push(`<li><i class="fas fa-user-secret text-red-500 mr-2"></i><span class="font-semibold">Suspicious Recipient:</span> Account flagged.</li>`); if (fraudReasons.length === 0) fraudReasons.push(`<li><i class="fas fa-clock text-red-500 mr-2"></i><span class="font-semibold">Atypical Pattern:</span> High-value transfer at ${timeString}.</li>`); }
            
            const transaction = { id: `TXN${Date.now().toString().slice(-6)}`, user: currentUsername, amount: formattedAmount, time: timeString, location: isFraudulent ? 'Delhi, IN' : 'Navi Mumbai, IN', status: 'Processing', isFraudulent: isFraudulent };
            
            let allTransactions = JSON.parse(localStorage.getItem('hfms-transactions') || '[]');
            allTransactions.unshift(transaction);
            localStorage.setItem('hfms-transactions', JSON.stringify(allTransactions));
            window.dispatchEvent(new StorageEvent('storage', { key: 'hfms-transactions' }));

            let i = 0; const interval = setInterval(() => { if(i < 4) { document.getElementById('analysis-step').textContent = ["Connecting...", "Verifying pattern...", "Checking device...", "Analyzing geo-location..."][i]; i++; } else { clearInterval(interval); document.getElementById('transaction-analysis').classList.add('hidden'); if (isFraudulent) { transaction.status = 'Flagged'; document.getElementById('fraud-detected-alert').querySelector('h2').textContent = `High-Risk Transaction Detected! (${formattedAmount})`; document.getElementById('fraud-detected-alert').querySelector('.bg-red-50 ul').innerHTML = fraudReasons.join(''); document.getElementById('fraud-detected-alert').classList.remove('hidden'); } else { transaction.status = 'Completed'; document.getElementById('transaction-safe').querySelector('h2').textContent = `Transaction Successful`; document.getElementById('transaction-safe').querySelector('p').textContent = `Your transaction of ${formattedAmount} was completed successfully.`; document.getElementById('transaction-safe').classList.remove('hidden'); } allTransactions[0] = transaction; localStorage.setItem('hfms-transactions', JSON.stringify(allTransactions)); window.dispatchEvent(new StorageEvent('storage', { key: 'hfms-transactions' }));} }, 800);
        }

        function resetSimulation() { document.getElementById('transaction-start').classList.remove('hidden'); document.getElementById('fraud-detected-alert').classList.add('hidden'); document.getElementById('transaction-safe').classList.add('hidden'); document.getElementById('transaction-analysis').classList.add('hidden'); document.getElementById('recipient').value = 'fraud-acct@scamupi'; document.getElementById('amount').value = '50000'; }

        // --- Modal & Recovery Logic ---
        function showBiometricModal() { const modal = document.getElementById('biometric-modal'); modal.classList.remove('hidden'); navigator.mediaDevices.getUserMedia({ video: true }).then(stream => { cameraStream = stream; document.getElementById('biometric-feed').srcObject = stream; setTimeout(() => { if (cameraStream) cameraStream.getTracks().forEach(track => track.stop()); document.getElementById('biometric-spinner').classList.remove('hidden'); setTimeout(() => { document.getElementById('biometric-spinner').classList.add('hidden'); document.getElementById('biometric-result').classList.remove('hidden'); document.getElementById('biometric-result').innerHTML = `<i class="fas fa-check-circle text-5xl text-green-500"></i>`; setTimeout(() => { modal.classList.add('hidden'); document.getElementById('action-modal').classList.remove('hidden'); }, 1000); }, 2000); }, 3000); }).catch(err => { alert("Camera access required."); modal.classList.add('hidden'); }); }
        function performAction(action) { document.getElementById('action-modal').classList.add('hidden'); document.getElementById('result-modal').classList.remove('hidden'); let allTransactions = JSON.parse(localStorage.getItem('hfms-transactions') || '[]'); const fraudTxnIndex = allTransactions.findIndex(t => t.isFraudulent && t.status === 'Flagged'); if (action === 'freeze') { document.getElementById('result-title').textContent = 'Account Frozen'; document.getElementById('result-message').textContent = 'Your account has been temporarily frozen. The suspicious transaction was reversed.'; } else { document.getElementById('result-title').textContent = 'Transaction Blocked'; document.getElementById('result-message').textContent = 'The fraudulent transaction has been blocked and reversed. Your account remains active.'; } if (fraudTxnIndex !== -1) { allTransactions[fraudTxnIndex].status = 'Reversed'; localStorage.setItem('hfms-transactions', JSON.stringify(allTransactions)); window.dispatchEvent(new StorageEvent('storage', { key: 'hfms-transactions' })); } document.getElementById('result-icon').innerHTML = `<i class="fas fa-check-circle text-5xl text-green-500"></i>`; }
        function closeAllModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden')); if (cameraStream) cameraStream.getTracks().forEach(track => track.stop()); resetSimulation(); }

        const recoveryForm = document.getElementById('recovery-form');
        recoveryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const verificationStatusEl = document.getElementById('recovery-verification-status');
            const file = document.getElementById('documents').files[0];
            if (!file || (!file.name.toLowerCase().includes('fir') && !file.name.toLowerCase().includes('statement'))) { verificationStatusEl.innerHTML = `<p class="text-red-600 mt-2">Invalid document. Please upload a valid proof.</p>`; verificationStatusEl.classList.remove('hidden'); return; }
            verificationStatusEl.innerHTML = `<p class="text-blue-600 mt-2">Verifying document...</p>`; verificationStatusEl.classList.remove('hidden');
            setTimeout(() => {
                verificationStatusEl.innerHTML = `<p class="text-green-600 mt-2"><i class="fas fa-check-circle"></i> Document verified.</p>`;
                setTimeout(() => {
                    const txnId = document.getElementById('transactionId').value;
                    let allTransactions = JSON.parse(localStorage.getItem('hfms-transactions') || '[]');
                    const targetTxnIndex = allTransactions.findIndex(t => t.id === txnId);
                    if(targetTxnIndex !== -1) { allTransactions[targetTxnIndex].status = 'Recovery In Progress'; currentRecoveryCase = { id: txnId, amount: allTransactions[targetTxnIndex].amount }; localStorage.setItem('hfms-transactions', JSON.stringify(allTransactions)); window.dispatchEvent(new StorageEvent('storage', { key: 'hfms-transactions' }));} 
                    else { currentRecoveryCase = { id: txnId, amount: 'N/A' }; }
                    document.getElementById('recovery-start').classList.add('hidden'); document.getElementById('recovery-process').classList.remove('hidden'); document.querySelectorAll('.step').forEach(s => s.classList.remove('active')); document.getElementById('cyber-cell-pending').classList.add('hidden'); document.getElementById('cyber-cell-action').classList.remove('hidden'); document.getElementById('cyber-cell-done').classList.add('hidden'); document.getElementById('bank-pending').classList.remove('hidden'); document.getElementById('bank-action').classList.add('hidden'); document.getElementById('bank-done').classList.add('hidden'); document.getElementById('authenticate-btn').disabled = false; document.getElementById('release-btn').disabled = true;
                    setTimeout(() => document.getElementById('step-1').classList.add('active'), 100); setTimeout(() => document.getElementById('step-2').classList.add('active'), 500);
                }, 1000);
            }, 1500);
        });
        function cyberCellAuthenticate() { document.getElementById('authenticate-btn').disabled = true; document.getElementById('cyber-cell-action').classList.add('hidden'); document.getElementById('cyber-cell-done').classList.remove('hidden'); setTimeout(() => { document.getElementById('step-3').classList.add('active'); document.getElementById('bank-pending').classList.add('hidden'); document.getElementById('bank-action').classList.remove('hidden'); document.getElementById('release-btn').disabled = false; }, 1500); }
        function bankReleaseFunds() { document.getElementById('release-btn').disabled = true; document.getElementById('bank-action').classList.add('hidden'); document.getElementById('bank-done').classList.remove('hidden'); setTimeout(() => { document.getElementById('step-4').classList.add('active'); }, 1000); setTimeout(() => { document.getElementById('step-5').classList.add('active'); let allTransactions = JSON.parse(localStorage.getItem('hfms-transactions') || '[]'); const targetTxnIndex = allTransactions.findIndex(t => t.id === currentRecoveryCase.id); if (targetTxnIndex !== -1) { allTransactions[targetTxnIndex].status = 'Completed'; localStorage.setItem('hfms-transactions', JSON.stringify(allTransactions)); window.dispatchEvent(new StorageEvent('storage', { key: 'hfms-transactions' })); } document.getElementById('challan-details').innerHTML = `<p><strong>Challan ID:</strong> CHLN-${Date.now().toString().slice(-6)}</p><p><strong>Recovery ID:</strong> ${currentRecoveryCase.id}</p><p><strong>Amount Recovered:</strong> ${currentRecoveryCase.amount}</p><p><strong>Status:</strong> Credited to Account **** 1234</p><p><strong>Date:</strong> ${new Date().toLocaleDateString('en-IN')}</p>`; setTimeout(() => document.getElementById('challan-modal').classList.remove('hidden'), 500); }, 2500); }
        function resetRecovery() { document.getElementById('recovery-start').classList.remove('hidden'); document.getElementById('recovery-process').classList.add('hidden'); recoveryForm.reset(); currentRecoveryCase = { id: null, amount: null }; document.getElementById('recovery-verification-status').classList.add('hidden'); }
    </script>
</body>
</html>


